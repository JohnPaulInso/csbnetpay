<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Historical Netpay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Manifest & Icons -->
    <link rel="manifest" href="/csbnetpay/manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png" sizes="any">

    <link rel="stylesheet" href="index.css">
    
    <style>













    </style>
</head>

<body>
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-links">
                    <a class="nav-link active" href="index.html">NETPAY</a>
                    <a class="nav-link" href="index2.html">DEDAMT</a>
                    <a class="nav-link" href="index3.html">ONQ</a>
                    <a class="nav-link" href="index4.html">PLI</a>
                    <a class="nav-link" href="index5.html">LE</a>
                </div>
                <button class="logout-btn" onclick="logout()">↪</button>
            </div>
        </nav>

        
        

        



        <div class="page-header" style="position: relative; display: flex; align-items: center; justify-content: space-between;">
            <h1 style="margin: 0; ;">HISTORICAL NETPAY</h1>
        
           

            <label class="switch">
                <input type="checkbox" id="ttsSwitch" checked>
                <span class="slider round">
                  <i class="bi bi-volume-up-fill icon"></i>
                </span>
              </label>

        </div>
        
        






    <!-- Search Section -->
    <div class="search-card">
        <div class="card">
            <div class="input-group">
                <label class="input-label" for="searchInputNetpay">Employee Number</label>


                <div class="input-wrapper">
                    
                  
           <div class="input-with-icon">
    <input
        type="text"
        id="searchInputNetpay"
        class="form-input"
        placeholder="Employee Number..."
        autocomplete="on"
    />



    <button type="button" id="micBtn" class="mic-inside-input">
        <i class="bi bi-mic-fill"></i>
    </button>
</div>




                    
                    <i class="bi bi-search input-icon"></i>
                    


                    
                </div>

<div id="feedback" class="feedback-text"></div>

            </div>
            <button id="searchButtonNetpay" class="btn btn-primary">
                <i class="bi bi-search"></i>
                Search Employee
            </button>
        </div>

        <!-- Microphone Section
        <div class="mic-section">
            <button id="micBtn" class="btn btn-primary btn-mic">
                <i class="bi bi-mic"></i>
                <span>Start Speaking</span>
            </button>
            <div id="feedback" class="feedback-text"></div>
        </div> -->

        <!-- Loading Indicator -->
        <div id="loadingIndicatorNetpay" class="loading-indicator">
            <img src="loading.gif" alt="Loading...">
        </div>
    </div>

    <!-- Listening Overlay -->
    <div id="listeningOverlay" class="listening-overlay"></div>

    <!-- Results Section -->
    <div class="results-section">
        <h3 id="employeeInfoNetpay" class="employee-info"></h3>
        <div id="resultsNetpay" class="table-container">
            <!-- Table will be dynamically inserted here -->
        </div>
    </div>

    




    

    <!-- Admin Section (Upload) -->
    <div class="admin-section container-admin" style="display: none;">

        <div class="admin-card">
            <div class="admin-card__header">
                <div>
                    <div class="admin-card__eyebrow">Admin · Abstract uploader</div>
                    <h5>Upload Latest Abstract</h5>
                    <p>Select the month and year, then upload an .xlsx file with NETPAY, POS, ONQUEUE, and PLI sheets.</p>
                </div>
                <div class="summary-chip">Uploading</div>
            </div>

            <div class="admin-grid">
                <div class="admin-card__body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="input-label">Month</label>
                            <select id="monthSelect" class="form-select">
                                <option value="" disabled selected>Select Month</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="input-label">Year</label>
                            <select id="yearSelect" class="form-select">
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <div class="file-upload-wrapper drop-zone">
                            <label for="abstractFileInput" class="file-upload-label">Choose .xlsx File</label>
                            <input type="file" id="abstractFileInput" class="file-input" accept=".xlsx" onchange="updateAbstractFileName()">
                            <small id="abstractFileName" class="file-name">No file chosen</small>
                            <div class="file-hint">Drag & drop or click to select your abstract file.</div>
                        </div>
                    </div>

                    <div class="convert-actions">
                        <button id="convertButton" class="btn btn-primary" onclick="convertExcelToCSV()">
                            <span id="buttonText">CONVERT</span>
                            <span id="buttonSpinner" class="spinner"></span>
                        </button>
                        <div class="convert-hint">Convert to CSV before distributing to your team.</div>
                    </div>

                    <small id="pliWarning" class="warning-text">Take note: Recheck the PLI file exceeding 25 MB</small>

                    <div id="progressContainer" class="progress-container">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar">0%</div>
                        </div>
                        <small id="progressText" class="progress-text">Processing...</small>
                    </div>

                    <div id="downloadButtons" class="download-buttons"></div>
                </div>

                <div class="upload-summary-card">
                    <div class="summary-header">
                        <div>
                            <div class="summary-eyebrow">Upload cart</div>
                            <h6 style="margin: 0;">What you'll process</h6>
                        </div>
                        <div class="summary-chip">Live</div>
                    </div>
                    <div class="summary-list">
                        <div class="summary-item">
                            <div>
                                <div class="summary-label">Month</div>
                                <div class="summary-value" id="cartMonth">Not selected</div>
                            </div>
                            <span class="status-dot idle" id="cartMonthStatus"></span>
                        </div>
                        <div class="summary-item">
                            <div>
                                <div class="summary-label">Year</div>
                                <div class="summary-value" id="cartYear">2025</div>
                            </div>
                            <span class="status-dot ready"></span>
                        </div>
                        <div class="summary-item">
                            <div>
                                <div class="summary-label">File</div>
                                <div class="summary-value" id="cartFile">No file chosen</div>
                            </div>
                            <span class="status-dot idle" id="cartFileStatus"></span>
                        </div>
                    </div>
                    <div class="summary-footer">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#16a34a;"></span>
                        <span>Keep this green by picking month, year, and file.</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Another Admin Section -->
    <div class="admin-section container-admin" style="display: none;">
        <div class="admin-chip">
        <div class="admin-card">
            <h5>Already have the Netpay for <span style="color: #00c12d;" id="month-name"></span>?</h5>
            <p>Please double check the month and year and make sure it's a CSV File. Example: <u id="example-file">feb25.csv</u></p>

            <div class="form-group" style="margin-bottom: 1rem;">
                <div class="upload-chip">
                    <div class="file-upload-wrapper">
                        <label for="fileInput" class="file-upload-label">Choose File</label>
                        <input type="file" id="fileInput" class="file-input" onchange="updateFileName()">
                        <small id="fileName" class="file-name">No file chosen</small>
                    </div>
                    <button onclick="uploadFile()" class="btn btn-success">Upload</button>
                </div>
            </div>
        </div>
        </div>
    </div>





<!-- Floating Speaking Indicator -->
<div id="ttsFloating" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4F2683;
    color: white;
    padding: 10px 15px;
    border-radius: 50px;
    font-weight: 600;
    display: none;
    z-index: 2000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
">
</div>

<!-- Stop TTS Button -->
<button id="stopTTS" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    font-weight: 600;
    display: none;
    z-index: 2000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
">Stop</button>







<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("searchButtonNetpay").addEventListener("click", function () {
            var employeeNumber = document.getElementById("searchInputNetpay").value.trim();
    
            if (employeeNumber) {
                localStorage.setItem("employeeNumber", employeeNumber); // ✅ Save employee number
                console.log("✅ Employee Number Stored:", employeeNumber); // Debugging
            } else {
                console.log("❌ No Employee Number Entered.");
            }
        });
    });
    document.addEventListener("DOMContentLoaded", function() {
        var employeeNumber = localStorage.getItem("employeeNumber"); // Retrieve the employee number

        if (employeeNumber) {
            console.log("Retrieved Employee Number:", employeeNumber);  // Debug log
            document.getElementById("searchInputNetpay").value = employeeNumber; // Fill the input

            // Automatically trigger the search button click
            document.getElementById("searchButtonNetpay").click();
        } else {
            console.log("No employee number found in localStorage.");  // Debug log
        }
    });
    </script>
    


    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Ripple Effect for Buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn') || e.target.closest('.btn')) {
                const button = e.target.classList.contains('btn') ? e.target : e.target.closest('.btn');
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                button.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            }
        });

        // Search Button Handler
document.addEventListener("DOMContentLoaded", function () {
    const searchBtn = document.getElementById("searchButtonNetpay");
    const searchInput = document.getElementById("searchInputNetpay");
    const resultsSection = document.querySelector(".results-section");

    // Ensure hidden on first load
    resultsSection.style.display = "none";

 searchBtn.addEventListener("click", function () {
    const employeeNumber = searchInput.value.trim();

    if (employeeNumber) {
        localStorage.setItem("employeeNumber", employeeNumber);
        console.log("✅ Employee Number Stored:", employeeNumber);

        // Show results
        resultsSection.style.display = "block";

        // Wait a bit for table to populate (if populated asynchronously)
        setTimeout(() => {
            readEmployeeResults(); // <-- this will read the results aloud
        }, 3000); 
    } else {
        console.log("❌ No Employee Number Entered.");
        resultsSection.style.display = "none";
    }
});

function stopReading() {
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
    }
}


    // Enter key support
    searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            searchBtn.click();
        }
    });
});

        // Voice Recognition
        const micBtn = document.getElementById("micBtn");
        const feedback = document.getElementById("feedback");
        const listeningOverlay = document.getElementById("listeningOverlay");

        const listeningSound = new Audio('listening.ogg');
        const searchingSound = new Audio('searching.ogg');
        listeningSound.preload = 'auto';
        searchingSound.preload = 'auto';

      function showFeedback(message) {
    feedback.textContent = message;
    feedback.style.display = "block";
}

function clearFeedback() {
    feedback.textContent = "";
    feedback.style.display = "none";
}


        function showOverlay() {
            listeningOverlay.classList.add('active');
        }

        function hideOverlay() {
            listeningOverlay.classList.remove('active');
        }

  function resetMicButton() {
    micBtn.classList.remove("listening");
    micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
    micBtn.disabled = false;
    hideOverlay();
}
  

        micBtn.addEventListener("click", () => {
            listeningSound.play();
            micBtn.disabled = true;
            startListening();
        });

        function startListening() {
            clearFeedback();

            if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
                showFeedback("Sorry, your browser does not support speech recognition.");
                resetMicButton();
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.continuous = true;

micBtn.classList.add("listening");
micBtn.innerHTML = `
    <div class="listening-dots">
        <span></span><span></span><span></span>
    </div>
`;


            recognition.start();
            showOverlay();

            let finalTranscript = "";
            let processingTimeout;

            recognition.onresult = (event) => {
                clearTimeout(processingTimeout);

                let interimTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                const combinedTranscript = (finalTranscript + interimTranscript).toLowerCase().trim();

                processingTimeout = setTimeout(() => {
                    searchingSound.play();
                    recognition.stop();
                    processCommand(combinedTranscript);
                }, 1000);
            };

            recognition.onerror = (event) => {
                showFeedback("Speech recognition error. Please try again.");
                recognition.stop();
                resetMicButton();
            };

            recognition.onend = () => {
                resetMicButton();
            };



            function processCommand(speech) {
    if (!speech) {
        showFeedback("Didn't catch that. Please try again.");
        return;
    }

    console.log("Processing speech:", speech);

    speech = speech.trim().toLowerCase();

    let employeeNumber = "";
    let matchedRoute = null;

    const routes = [
        { keywords: ["netpay", "net pay", "net payment"], file: "index.html", inputId: "searchInputNetpay" },
        { keywords: ["dedamt", "ded amount", "deduction amount", "positive", "deduction positive"], file: "index2.html", inputId: "searchInputPos" },
        { keywords: ["onqueue", "on q", "on queue", "onq", "queue", "onquee", "onqueu"], file: "index3.html", inputId: "searchInputOnq" },
        { keywords: ["pli", "pli deduction"], file: "index4.html", inputId: "searchInputPLI" }
    ];

    // First, try matching keywords
    for (const route of routes) {
        for (const keyword of route.keywords) {
            if (speech.startsWith(keyword)) {
                matchedRoute = route;
                const afterKeyword = speech.substring(keyword.length).trim();
                const digits = afterKeyword.match(/\d+/g);
                if (digits) employeeNumber = digits.join('');
                break;
            }
        }
        if (matchedRoute) break;
    }

    // If no keyword matched, check if speech contains numbers
    if (!matchedRoute) {
        const digits = speech.match(/\d+/g);
        if (digits) {
            employeeNumber = digits.join('');
            matchedRoute = routes[0]; // default to NETPAY
        }
    }

    if (!matchedRoute || !employeeNumber) {
        showFeedback("Command not recognized. Please try again.");
        return;
    }

    console.log("Matched route:", matchedRoute, "Employee number:", employeeNumber);

    localStorage.setItem("employeeNumber", employeeNumber);

    if (window.location.pathname.endsWith(matchedRoute.file)) {
        const inputField = document.getElementById(matchedRoute.inputId);
        if (inputField) {
            inputField.value = employeeNumber;
            clearFeedback();
            document.getElementById("searchButtonNetpay").click();
        }
    } else {
        setTimeout(() => {
            window.location.href = matchedRoute.file;
        }, 300);
    }
}

        }







let currentUtterance = null;
let autoReadDisabled = false; // gate to stop auto TTS when user interacts

function disableAutoRead() {
    autoReadDisabled = true;
    stopTTS();
}

// If the page was reloaded, don't auto-read results
const navEntry = performance.getEntriesByType("navigation")[0];
if (navEntry && navEntry.type === "reload") {
    disableAutoRead();
}

function getFemaleVoice() {
    const voices = speechSynthesis.getVoices();
    // Prefer voices that have "female" or "Google UK English Female" etc.
    return voices.find(v => /female/i.test(v.name)) || voices[0];
}
function readEmployeeResults() {
    stopTTS(); // stop any previous reading

    const infoEl = document.getElementById("employeeInfoNetpay");
    const tableEl = document.querySelector("#resultsNetpay table");
    if (!infoEl || !tableEl) return;

    // === Read NAME only first ===
    const nameMatch = infoEl.textContent.match(/NAME:\s*(.+)/i);
    const nameText = nameMatch ? nameMatch[1].trim() : "";

    if (!nameText) return;

    // First utterance: NAME only
    const nameUtterance = new SpeechSynthesisUtterance(nameText);
    nameUtterance.voice = getFemaleVoice();
    nameUtterance.rate = 1;
    nameUtterance.pitch = 1;

    // Second utterance: table content
    const headers = Array.from(tableEl.querySelectorAll("thead th")).map(th => th.textContent);
    const rows = tableEl.querySelectorAll("tbody tr");

    let tableSpeech = "";
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("td"));
        cells.forEach((cell, index) => {
            tableSpeech += `${headers[index]}: ${cell.textContent}. `;
        });
    });

    const tableUtterance = new SpeechSynthesisUtterance(tableSpeech);
    tableUtterance.voice = getFemaleVoice();
    tableUtterance.rate = 1;
    tableUtterance.pitch = 1;

    // Show floating TTS indicators
    const floating = document.getElementById("ttsFloating");
    const stopBtn = document.getElementById("stopTTS");
    floating.style.display = "block";
    stopBtn.style.display = "block";

    // When nameUtterance ends, start tableUtterance
    nameUtterance.onend = () => {
        speechSynthesis.speak(tableUtterance);
    };

    tableUtterance.onend = () => {
        floating.style.display = "none";
        stopBtn.style.display = "none";
        currentUtterance = null;
    };

    // Speak name first
    currentUtterance = nameUtterance;
    speechSynthesis.speak(nameUtterance);
}

// Stop TTS function
function stopTTS() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    const floating = document.getElementById("ttsFloating");
    const stopBtn = document.getElementById("stopTTS");
    floating.style.display = "none";
    stopBtn.style.display = "none";
    currentUtterance = null;
}

// Stop button click
document.getElementById("stopTTS").addEventListener("click", stopTTS);

// Stop reading if user clicks into any input-like control
document.addEventListener("focusin", (event) => {
    if (event.target.matches("input, textarea, select")) {
        disableAutoRead();
    }
});

// Stop lingering speech on reloads
window.addEventListener("pageshow", () => stopTTS());

// Ensure voices are loaded
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => { getFemaleVoice(); };
}
// After results appear
// After results appear
setTimeout(() => {
    if (autoReadDisabled) return;
    const table = document.querySelector("#resultsNetpay table");
    if (table) {
        readEmployeeResults();
    }
}, 500); 







        // Auto-fill from localStorage
        window.addEventListener("DOMContentLoaded", () => {
            const employeeNumber = localStorage.getItem("employeeNumber");
            if (employeeNumber) {
                const possibleInputIds = ["searchInputNetpay", "searchInputPos", "searchInputOnq", "searchInputPLI"];
                for (const id of possibleInputIds) {
                    const inputField = document.getElementById(id);
                    if (inputField) {
                        inputField.value = employeeNumber;
                        break;
                    }
                }
            }
        });

        // Excel Upload Functions
        function populateMonthDropdown() {
            const months = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const monthSelect = document.getElementById("monthSelect");

            for (let i = 2; i >= 0; i--) {
                const monthIndex = (currentMonth - i + 12) % 12;
                const option = document.createElement("option");
                option.value = months[monthIndex].substring(0, 3).toLowerCase();
                option.text = months[monthIndex];
                monthSelect.appendChild(option);
            }
        }

        function updateAbstractFileName() {
            const fileInput = document.getElementById("abstractFileInput");
            const fileName = document.getElementById("abstractFileName");
            fileName.textContent = fileInput.files.length
                ? `Selected file: ${fileInput.files[0].name}`
                : "No file chosen";
            refreshUploadCart();
        }

        function refreshUploadCart() {
            const monthSelect = document.getElementById("monthSelect");
            const yearSelect = document.getElementById("yearSelect");
            const fileInput = document.getElementById("abstractFileInput");

            const cartMonth = document.getElementById("cartMonth");
            const cartYear = document.getElementById("cartYear");
            const cartFile = document.getElementById("cartFile");
            const cartMonthStatus = document.getElementById("cartMonthStatus");
            const cartFileStatus = document.getElementById("cartFileStatus");

            if (monthSelect && cartMonth) {
                const monthText = monthSelect.selectedIndex > 0
                    ? monthSelect.options[monthSelect.selectedIndex].text
                    : "Not selected";
                cartMonth.textContent = monthText;
                cartMonthStatus?.classList.toggle("ready", monthSelect.selectedIndex > 0);
                cartMonthStatus?.classList.toggle("idle", monthSelect.selectedIndex <= 0);
            }

            if (yearSelect && cartYear) {
                cartYear.textContent = yearSelect.value || "2025";
            }

            if (fileInput && cartFile) {
                cartFile.textContent = fileInput.files.length
                    ? fileInput.files[0].name
                    : "No file chosen";
                const hasFile = fileInput.files.length > 0;
                cartFileStatus?.classList.toggle("ready", hasFile);
                cartFileStatus?.classList.toggle("idle", !hasFile);
            }
        }

        function updateFileName() {
            const fileInput = document.getElementById("fileInput");
            const fileName = document.getElementById("fileName");
            if (fileInput.files.length > 0) {
                fileName.textContent = `Selected file: ${fileInput.files[0].name}`;
            } else {
                fileName.textContent = "No file chosen";
            }
        }

        function getPreviousMonth() {
            const monthsShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const monthsFull = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const previousMonthIndex = (currentMonth - 1 + 12) % 12;
            return { short: monthsShort[previousMonthIndex], full: monthsFull[previousMonthIndex] };
        }

        window.onload = function() {
            populateMonthDropdown();
            const previousMonth = getPreviousMonth();
            const previousMonthText = previousMonth.short.toLowerCase() + '25.csv';
            if (document.getElementById("month-name")) {
                document.getElementById("month-name").textContent = previousMonth.full;
            }
            if (document.getElementById("example-file")) {
                document.getElementById("example-file").textContent = previousMonthText;
            }
            const monthSelect = document.getElementById("monthSelect");
            const yearSelect = document.getElementById("yearSelect");
            const abstractInput = document.getElementById("abstractFileInput");

            monthSelect?.addEventListener("change", refreshUploadCart);
            yearSelect?.addEventListener("change", refreshUploadCart);
            abstractInput?.addEventListener("change", refreshUploadCart);
            refreshUploadCart();
        }

        async function convertExcelToCSV() {
            const monthSelect = document.getElementById("monthSelect");
            const yearSelect = document.getElementById("yearSelect");
            const fileInput = document.getElementById("abstractFileInput");
            const progressContainer = document.getElementById("progressContainer");
            const progressBar = document.getElementById("progressBar");
            const progressText = document.getElementById("progressText");
            const convertButton = document.getElementById("convertButton");
            const buttonText = document.getElementById("buttonText");
            const buttonSpinner = document.getElementById("buttonSpinner");
            const pliWarning = document.getElementById("pliWarning");
            const downloadButtonsContainer = document.getElementById("downloadButtons");

            if (!monthSelect.value || !yearSelect.value) return alert("Please select both month and year.");
            if (!fileInput.files.length) return alert("Please select an .xlsx file.");

            convertButton.disabled = true;
            buttonText.style.display = 'none';
            buttonSpinner.style.display = 'inline-block';
            progressContainer.style.display = "block";
            progressBar.style.width = "0%";
            progressBar.textContent = "0%";
            progressText.textContent = "Initializing...";
            pliWarning.style.display = "none";
            downloadButtonsContainer.style.display = "none";
            downloadButtonsContainer.innerHTML = "";

            const file = fileInput.files[0];
            const reader = new FileReader();
            const filesToDownload = [];

            const timeout50 = setTimeout(() => {
                progressBar.style.width = "50%";
                progressBar.textContent = "50%";
                progressText.textContent = "Working on it (50%)...";
            }, 5000);

            const timeout80 = setTimeout(() => {
                progressBar.style.width = "80%";
                progressBar.textContent = "80%";
                progressText.textContent = "Still processing (80%)...";
            }, 20000);

            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });

                    const sheetsToProcess = [
                        {
                            names: ["NETPAY", "netpay", "netPay"],
                            output: `${monthSelect.value}${yearSelect.value.slice(-2)}.csv`,
                            numberColumn: "H"
                        },
                        {
                            names: ["POS", "pos", "positive", "dedamt"],
                            output: `pos_${monthSelect.value}${yearSelect.value.slice(-2)}.csv`,
                            numberColumn: "N"
                        },
                        {
                            names: ["ONQUEUE", "ONQ", "QUEQUE"],
                            output: `onq_${monthSelect.value}${yearSelect.value.slice(-2)}.csv`,
                            numberColumn: "N"
                        },
                        {
                            names: ["PLI", "pli"],
                            output: `pli_${monthSelect.value}${yearSelect.value.slice(-2)}.csv`,
                            clearColumns: ["A", "S", "T", "U", "V", "W", "X", "Y", "Z"],
                            numberColumn: "O"
                        }
                    ];

                    const presentSheets = sheetsToProcess.filter(sheetConfig =>
                        Object.keys(workbook.Sheets).some(name => sheetConfig.names.includes(name))
                    );

                    if (presentSheets.length === 0) {
                        alert('No matching sheets found in the Excel file.');
                        resetUI();
                        return;
                    }

                    for (const sheetConfig of presentSheets) {
                        const sheetName = Object.keys(workbook.Sheets).find(name => sheetConfig.names.includes(name));
                        let sheet = workbook.Sheets[sheetName];

                        if (sheetConfig.clearColumns) {
                            const range = XLSX.utils.decode_range(sheet["!ref"]);
                            for (let col = range.s.c; col <= range.e.c; col++) {
                                const colLetter = XLSX.utils.encode_col(col);
                                if (sheetConfig.clearColumns.includes(colLetter)) {
                                    for (let row = range.s.r; row <= range.e.r; row++) {
                                        const cellAddress = `${colLetter}${row + 1}`;
                                        delete sheet[cellAddress];
                                    }
                                }
                            }
                        }

                        if (sheetConfig.numberColumn) {
                            const range = XLSX.utils.decode_range(sheet["!ref"]);
                            const colIndex = XLSX.utils.decode_col(sheetConfig.numberColumn);
                            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                                const cellAddress = XLSX.utils.encode_cell({ c: colIndex, r: row });
                                const cell = sheet[cellAddress];
                                if (cell && typeof cell.v === 'string') {
                                    const numeric = parseFloat(cell.v.replace(/,/g, ''));
                                    if (!isNaN(numeric)) {
                                        cell.v = numeric;
                                        cell.t = 'n';
                                    }
                                }
                            }
                        }

                        const csv = XLSX.utils.sheet_to_csv(sheet, {
                            FS: ",",
                            RS: "\r\n",
                            blankrows: false
                        });

                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

                        if (sheetConfig.output.startsWith('pli_') && blob.size > 25 * 1024 * 1024) {
                            pliWarning.style.display = "block";
                        }

                        filesToDownload.push({
                            filename: sheetConfig.output,
                            blob: blob
                        });

                        progressText.textContent = `Prepared ${sheetConfig.output}`;
                    }

                    clearTimeout(timeout50);
                    clearTimeout(timeout80);

                    progressBar.style.width = "100%";
                    progressBar.textContent = "100%";
                    progressText.textContent = "Conversion complete!";

                    const downloadBtn = document.createElement("button");
                    downloadBtn.className = "btn btn-success";
                    downloadBtn.textContent = "Download All Files";
                    downloadBtn.onclick = () => {
                        filesToDownload.forEach(file => {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(file.blob);
                            link.download = file.filename;
                            link.style.display = "none";
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(link.href);
                        });
                    };
                    downloadButtonsContainer.appendChild(downloadBtn);
                    downloadButtonsContainer.style.display = "block";

                    resetUI();
                } catch (error) {
                    alert('Error processing the Excel file: ' + error.message);
                    resetUI();
                }
            };

            reader.readAsArrayBuffer(file);

            function resetUI() {
                buttonText.style.display = 'inline';
                buttonSpinner.style.display = 'none';
                convertButton.disabled = false;
                setTimeout(() => progressContainer.style.display = 'none', 2000);
            }
        }

        function logout() {
            console.log("Logging out...");
            // Add your logout logic here
        }

        // Auto-trigger search on load
        document.addEventListener("DOMContentLoaded", function() {
            var employeeNumber = localStorage.getItem("employeeNumber");

            if (employeeNumber) {
                console.log("Retrieved Employee Number:", employeeNumber);
                document.getElementById("searchInputNetpay").value = employeeNumber;
                document.getElementById("searchButtonNetpay").click();
            } else {
                console.log("No employee number found in localStorage.");
            }
        });



    </script>







<script>
    // =============================
    // TTS Switch & Toggle Handling
    // =============================

    const ttsSwitch = document.getElementById("ttsSwitch");
    const icon = document.querySelector(".slider .icon");

    // Load saved state from localStorage
    let savedTTS = localStorage.getItem("ttsEnabled");
    let ttsEnabled = savedTTS === null ? true : savedTTS === "true"; // default ON

    // Initialize switch and icon
    ttsSwitch.checked = ttsEnabled;
    icon.className = ttsEnabled ? "bi bi-volume-up-fill icon" : "bi bi-volume-mute-fill icon";

    // Listen for switch changes
    ttsSwitch.addEventListener("change", () => {
        ttsEnabled = ttsSwitch.checked;
        localStorage.setItem("ttsEnabled", ttsEnabled); // save state

        if (ttsEnabled) {
            icon.className = "bi bi-volume-up-fill icon";
            console.log("TTS ON");
        } else {
            icon.className = "bi bi-volume-mute-fill icon";
            console.log("TTS OFF");
            stopTTS(); // stop ongoing speech immediately
        }
    });

    // Optional separate toggle button (if you have one)
    const ttsToggleBtn = document.getElementById("ttsToggleBtn");
    if (ttsToggleBtn) {
        ttsToggleBtn.innerHTML = ttsEnabled ? '<i class="bi bi-volume-up-fill"></i>' : '<i class="bi bi-volume-mute-fill"></i>';
        ttsToggleBtn.addEventListener("click", () => {
            ttsEnabled = !ttsEnabled;
            localStorage.setItem("ttsEnabled", ttsEnabled);
            ttsSwitch.checked = ttsEnabled;
            icon.className = ttsEnabled ? "bi bi-volume-up-fill icon" : "bi bi-volume-mute-fill icon";
            ttsToggleBtn.innerHTML = ttsEnabled ? '<i class="bi bi-volume-up-fill"></i>' : '<i class="bi bi-volume-mute-fill"></i>';
            if (!ttsEnabled) stopTTS();
        });
    }

    // =============================
    // Wrap TTS function to respect toggle
    // =============================
    const originalReadEmployeeResults = readEmployeeResults;
    readEmployeeResults = function() {
        if (!ttsEnabled) return; // do nothing if TTS is off
        originalReadEmployeeResults();
    };

    function gatedReadEmployeeResults() {
        if (!ttsEnabled) return;
        readEmployeeResults();
    }
</script>



<script src="index.script"></script>

</body>
</html>
